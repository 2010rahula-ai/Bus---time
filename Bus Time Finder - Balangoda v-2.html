
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Time Finder - Balangoda v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --accent: #c2ff69;

            --sltb-red: #ef4444;
            --private-green: #10b981;
            --bg-dark: #0f1724;
            --card-bg: #1a2233;
            --text-main: #ffffff;
            --text-muted: #9aa4b2;
            --header-bg: #0b1220;
            --transition: 300ms cubic-bezier(.22,.9,.3,1);
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark); color: var(--text-main);
            overflow: hidden;
        }

        /* Layout */
        .app-container { display: flex; flex-direction: column; height: 100%; }

        
        header {
            background: var(--header-bg); padding: 15px; text-align: center;
            font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition); z-index: 1000;
        }

        .content-area { flex: 1; overflow-y: auto; position: relative; }
        
        .section { display: none; padding: 15px; height: 100%; }
        .section.active { display: block; }

        /* Navigation */
        nav {
            background: var(--header-bg); display: flex; justify-content: space-around;
            padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition); z-index: 1000;
        }
        .nav-item { color: var(--text-muted); text-align: center; font-size: 0.8rem; flex: 1; cursor: pointer; }
        .nav-item.active {
	color: #a6ff25;
	font-weight: bold;
}
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }

        /* Cards & Inputs */
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        input, select {
            width: 100%; background: #2a3447; border: 1px solid #3d4b66;
            color: white; padding: 10px; margin: 8px 0; border-radius: 8px;

        }

        /* Results & Labels */
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .service-badge { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .badge-sltb {
	background: #f20808;
}
        .badge-private { background: var(--private-green); }

        .time-label { color: var(--text-muted); font-size: 0.9rem; }
        .location-val { font-weight: bold; color: var(--accent); }

        /* Map UI */
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .map-overlay-tools {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 900; display: flex; gap: 5px; width: 90%;
        }
        .side-menu {
	position: absolute;
	bottom: 20px;
	right: 25px;
	z-index: 900;
	display: flex;
	flex-direction: column;
	align-items: flex-end;
}
        .menu-btn {
	background: #29ec0e;
	color: #0d0d0d;
	width: 50px;
	height: 50px;
	border-radius: 25px;
	display: flex;
	justify-content: center;
	align-items: center;
	margin-top: 10px;
	box-shadow: 0 4px 10px rgba(0,0,0,0.5);
	font-size: 1.2rem;
}
        .hidden-tools { display: none; flex-direction: column; transition: var(--transition); }

        /* Fullscreen Map Mode */
        .fullscreen-map header { transform: translateY(-100%); }
        .fullscreen-map nav { transform: translateY(100%); }

        /* Settings Toggle */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
button {
	background-color: #30ec20;
	color: #0b0b0b;
	border: none;
	border-radius: 5px;
	padding: 2px 5px;
	font-size: 13px;
	font-weight: bold;
}
    </style>
</head>
<body>

<div class="app-container" id="app">
    <header id="appHeader">Buses</header>

    <div class="content-area">
        <section id="buses" class="section active">
           

            <div class="card">
                <select id="routeSelect" onchange="updateStops()">
                    <option value="welioya">Balangoda-Welioya (08)</option>
                    <option value="kaltota">Balangoda-Welifatayaya-Kaltota (10)</option>
                    <option value="mulgama">Balangoda-Rajavaka-Mulgama (12)</option>
                </select>
                <select id="dirSelect">

                    <option value="down">Down (To Village)</option>
                    <option value="up">Up (To Balangoda)</option>
                </select>
                <select id="fromSelect" placeholder="From Stop"></select>
                <select id="toSelect" placeholder="To Stop"></select>
                
                <div style="display:flex; gap:5px;">
                    <input type="time" id="timeInput" style="flex:2;">
                    <button onclick="setNow()" style="flex:1; height: 35px;margin: 8px 0px;">NOW</button>
                    <button onclick="calculateBus()" style="flex:1;margin: 8px 0px; background: #ff5f20; color: white; height: 35px;">SET</button>
                </div>
            </div>

            <div class="card" style="text-align: center;">

                <h4>Bus Simulator</h4>
                <div id="simStatus" style="font-size: 0.8rem; color: var(--text-muted);">
                    Simulating current traffic on GPX route...
                </div>
            </div>
 <div class="card" id="resultsCard">
                <div class="result-header">
                    <span id="routeTitle">Route 08: Balangoda - Welioya</span>
                    <span id="serviceType" class="service-badge badge-sltb">SLTB</span>
                </div>
                <p><span class="time-label">From:</span> <span class="location-val" id="resFrom">Balangoda</span> @ <span id="resFromTime">--:--</span></p>
                <p><span class="time-label">To:</span> <span class="location-val" id="resTo">Kaltota</span> @ <span id="resToTime">--:--</span></p>
                
                <div style="display:flex; gap:10px; margin: 15px 0;">
                    <button onclick="changeBus(-1)" style="flex:1; padding:8px;">Previous Bus</button>
                    <button onclick="changeBus(1)" style="flex:1; padding:8px;">Next Bus</button>
                </div>

                <div style="font-size: 0.85rem; border-top: 1px solid #3d4b66; padding-top:10px;">
                    <div>Departure: <span id="detDep">Balangoda (06:00)</span></div>
                    <div>Destination: <span id="detDest">Welioya (07:30)</span></div>
                    <div>Distance: <span id="detDist">34 km</span></div>
                </div>
            </div>
        </section>

        <section id="mapSection" class="section">
            <div class="map-overlay-tools">
                <button id="mapFromBtn" style="flex:1;">From Stop</button>
                <button id="mapToBtn" style="flex:1;">To Stop</button>
            </div>
            <div id="map"></div>
            <div class="side-menu">
                <div class="hidden-tools" id="mapTools">
                    <div class="menu-btn" title="Layers"><i class="fas fa-layer-group"></i></div>

                    <div class="menu-btn" title="Save Loc"><i class="fas fa-bookmark"></i></div>
                    <div class="menu-btn" title="Record"><i class="fas fa-circle"></i></div>
                </div>
                <div class="menu-btn" onclick="toggleMapMenu()"><i class="fas fa-plus"></i></div>
            </div>
        </section>

        <section id="saved" class="section">
            <h3>Locations</h3>
            <div id="savedLocationsList" class="card">No saved locations.</div>
            <h3>Tracks</h3>
            <div id="savedTracksList" class="card">No saved tracks.</div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1;">Import GPX</button>
                <button style="flex:1;">Export Data</button>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="toggle-row">
                <span>Theme: Dark Mode</span>
                <input type="checkbox" checked style="width: auto;">
            </div>
            <div class="toggle-row">
                <span>Language: English</span>
                <button>Change to Sinhala</button>
            </div>
            <hr>
            <h4>Map Layers</h4>
            <div id="layerToggles">
                <label><input type="checkbox" checked> OSM Standard</label><br>
                <label><input type="checkbox"> Google Sat</label><br>
                <label><input type="checkbox"> Offline Topo</label>
            </div>

            <hr>
            <div class="toggle-row">
                <span>GPS Device</span>
                <button onclick="toggleGPS()">ON/OFF</button>
            </div>
            <div class="toggle-row">
                <span>15 min Notification</span>
                <input type="checkbox">
            </div>
        </section>
    </div>

    <nav>
        <div class="nav-item active" onclick="showSection('buses', this)"><i class="fas fa-bus"></i>Buses</div>
        <div class="nav-item" onclick="showSection('mapSection', this)"><i class="fas fa-map-marked-alt"></i>Map</div>
        <div class="nav-item" onclick="showSection('saved', this)"><i class="fas fa-heart"></i>Saved</div>

        <div class="nav-item" onclick="showSection('settings', this)"><i class="fas fa-cog"></i>Settings</div>
    </nav>
</div>

<script>
    // --- Data ---
    const busData = {
        speed: 26, // km/h
        stopWait: 0.5, // 30 seconds
        routes: {
            welioya: {
                name: "Balangoda-Welioya", num: "08", distance: 34,
                stops: [
                    {n: 'Balangoda', d: 0}, {n: 'Kirimatitenna', d: 3.5}, {n: 'depalamulla', d: 8.1},
                    {n: 'bowatta', d: 10}, {n: 'rajavaka', d: 13.5}, {n: 'nawaneliya', d: 17},
                    {n: 'molamure', d: 18.5}, {n: 'tanjantenna', d: 22.5}, {n: '16thPost', d: 25},
                    {n: 'kaltota', d: 29}, {n: 'udaKolaniya', d: 31}, {n: 'Welioya', d: 34}

                ],
                buses: [
                    {dep: '06:00', service: 'SLTB'}, {dep: '07:30', service: 'SLTB'},
                    {dep: '08:30', service: 'PRIVATE'}, {dep: '09:00', service: 'SLTB'},
                    {dep: '10:20', service: 'SLTB'}, {dep: '15:00', dest: 'Hambegamuwa', service: 'SLTB'}
                ]
            }
            // Add other routes here following the pattern...
        }
    };

    let currentRoute = 'welioya';
    let busIndex = 0;

    // --- UI Logic ---
    function showSection(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('appHeader').innerText = el.innerText;
        if(id === 'mapSection') { setTimeout(() => map.invalidateSize(), 200); }
    }

    function toggleMapMenu() {
        const tools = document.getElementById('mapTools');
        tools.style.display = tools.style.display === 'flex' ? 'none' : 'flex';
    }

    // Fullscreen Map Logic
    let lastTap = 0;
	document.getElementById('map').addEventListener('touchstart', function(e) {
        let now = new Date().getTime();
        let timesince = now - lastTap;
        if (timesince < 300 && timesince > 0) {
            document.getElementById('app').classList.toggle('fullscreen-map');
        }
        lastTap = now;
    });

    // --- Calculation Logic ---
    function updateStops() {
        const route = busData.routes[document.getElementById('routeSelect').value];
        const fromS = document.getElementById('fromSelect');
        const toS = document.getElementById('toSelect');
        fromS.innerHTML = toS.innerHTML = '';
        route.stops.forEach(s => {
            let opt = `<option value="${s.d}">${s.n} </option>`;
            fromS.innerHTML += opt; toS.innerHTML += opt;
        });
    }

    function setNow() {
        const now = new Date();
        document.getElementById('timeInput').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    }

    function calculateBus() {
        const routeId = document.getElementById('routeSelect').value;
        const route = busData.routes[routeId];
        const depTime = document.getElementById('timeInput').value;
        const fromDist = parseFloat(document.getElementById('fromSelect').value);
        const toDist = parseFloat(document.getElementById('toSelect').value);
        
        // Simple logic: Find first bus where (Base Departure + Time to reach "From") > Input Time
        const buses = route.buses;
        const timeToReach = (fromDist / busData.speed) * 60; // minutes
        
        // Update UI result card
        const bus = buses[busIndex];
        document.getElementById('resFrom').innerText = document.getElementById('fromSelect').options[document.getElementById('fromSelect').selectedIndex].text;
        document.getElementById('resTo').innerText = document.getElementById('toSelect').options[document.getElementById('toSelect').selectedIndex].text;
        document.getElementById('serviceType').innerText = bus.service;
        document.getElementById('serviceType').className = `service-badge ${bus.service === 'SLTB' ? 'badge-sltb' : 'badge-private'}`;
        // More specific time calculations would go here...
    }

    // --- Map Initialization ---
    const map = L.map('map').setView([6.65, 80.70], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // GPX Integration
    function loadGpx(fileUrl) {

        new L.GPX(fileUrl, {
            async: true,
            polyline_options: { color: 'orange', weight: 4 }
        }).on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());
        }).addTo(map);
    }

    // On Load
    window.onload = () => {
        updateStops();
        setNow();
        // Mocking GPX load (replace with actual file paths)
        // loadGpx('BLG-Welioya.gpx'); 
    };
</script>

</body>
</html>