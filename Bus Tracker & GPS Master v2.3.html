<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Tracker & GPS v2.2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #007bff; --sltb: #ff0000; --private: #28a745; 
            --bg: #f4f4f4; --card: #ffffff; --text: #333; --accent-green: #2ecc71;
        }

        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; transition: 0.3s; }

        header { height: 45px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--card); border-bottom: 1px solid #ddd; z-index: 1100; transition: transform 0.3s; }
        header.hidden { transform: translateY(-100%); }
        .trash-btn { font-size: 1.2rem; cursor: pointer; color: #ff4444; display: none; }

        #tab-map { padding: 0; height: calc(100vh - 120px); position: relative; transition: height 0.3s; }
        body.fullscreen #tab-map { height: 100vh; }
        #map { height: 100%; width: 100%; filter: none !important; }

        .side-menu { position: absolute; bottom: 20px; right: 20px; z-index: 1101; display: flex; flex-direction: column; gap: 10px; }
        .menu-item, .menu-toggle { width: 45px; height: 45px; border-radius: 50%; background: #222; border: none; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s ease; }
        .menu-toggle { background: var(--primary); }
        .extra-tools { display: none; flex-direction: column; gap: 10px; opacity: 0; transform: translateY(20px); transition: 0.3s ease; }
        .extra-tools.show { display: flex; opacity: 1; transform: translateY(0); }

        #layer-panel { display: none; position: absolute; bottom: 80px; right: 80px; background: var(--card); color: var(--text); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1002; width: 200px; }
        .layer-option { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 14px; }

        .page { display: none; height: calc(100vh - 120px); overflow-y: auto; padding: 15px; }
        .page.active { display: block; }

        .storage-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; transition: 0.2s; position: relative; }
        .storage-card.selected { border: 2px solid #ff4444; background: rgba(255, 68, 68, 0.05); }
        
        footer { position: fixed; bottom: 0; width: 100%; height: 60px; display: flex; background: var(--card); z-index: 1100; border-top: 1px solid #ddd; transition: transform 0.3s; }
        footer.hidden { transform: translateY(100%); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <header id="main-header">
        <div style="font-weight: 1000; color: var(--primary);">BUS TIME</div>
        <div class="trash-btn" id="delete-btn" onclick="deleteSelected()">🗑️</div>
    </header>

    <main>
        <section id="tab-time" class="page active">
            <h2 id="clock-display" style="text-align:center; font-size: 3rem; margin-bottom: 20px;">00:00</h2>
            <div id="bus-results"></div>
        </section>

        <section id="tab-map" class="page">
            <div id="map"></div>
            <div id="layer-panel">
                <div class="layer-option" onclick="changeLayer('std')"><input type="radio" name="layer" id="rad-std"> Standard</div>
                <div class="layer-option" onclick="changeLayer('topo')"><input type="radio" name="layer" id="rad-topo"> Topographic</div>
                <div class="layer-option" onclick="changeLayer('sat')"><input type="radio" name="layer" id="rad-sat"> Satellite</div>
                <hr style="margin: 10px 0; opacity: 0.2;">
                <div class="layer-option" onclick="toggleHillshade()"><input type="checkbox" id="chk-hill"> Hillshades Overlay</div>
            </div>

            <div class="side-menu">
                <div id="extra-tools" class="extra-tools">
                    <input type="file" id="gpxInput" accept=".gpx" style="display: none;" onchange="handleGpxUpload(event)">
                    <button class="menu-item" onclick="document.getElementById('gpxInput').click()" title="Import GPX" style="background: #3498db"><i class="fas fa-file-import"></i></button>
                    <button class="menu-item" onclick="toggleLayerPanel()" title="Map Layers" style="background: #e67e22"><i class="fas fa-layer-group"></i></button>
                    <button class="menu-item" onclick="findMe()" title="Find Location"><i class="fas fa-crosshairs"></i></button>
                    <button class="menu-item" onclick="saveCurrentLocation()" title="Save Location"><i class="fas fa-thumbtack"></i></button>
                    <button class="menu-item" id="rec-btn" onclick="toggleRecording()" title="Record Track"><i class="fas fa-route"></i></button>
                </div>
                <button class="menu-toggle" onclick="toggleMapMenu()"><i class="fas fa-plus" id="toggleIcon"></i></button>
            </div>
        </section>

        <section id="tab-storage" class="page">

            <h3 style="margin-bottom:15px; font-size:0.9rem; color:#888;">SAVED CONTENT</h3>
            <div id="storage-list"></div>
        </section>
    </main>

    <footer id="bottom-nav">
        <div class="nav-item active" onclick="switchView('tab-time')">BUSES</div>
        <div class="nav-item" onclick="switchView('tab-map')">MAP</div>
        <div class="nav-item" onclick="switchView('tab-storage')">STORAGE</div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script>
        let map, userTrack = [], isRecording = false, lastTap = 0;
        let storage = JSON.parse(localStorage.getItem('app_storage')) || [];
        let mapLayers = {};
        let currentBaseLayer, hillshadeLayer;

        const baseMaps = {
            std: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
            topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
            sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
        };

        window.onload = () => {
            initMap();
            renderStorage();
            startClock();
            setupGestures();
        };


        function initMap() {
            const savedState = JSON.parse(localStorage.getItem('map_state')) || { center: [6.7106, 80.6901], zoom: 13, layer: 'std', hill: false };
            map = L.map('map', { zoomControl: false }).setView(savedState.center, savedState.zoom);
            changeLayer(savedState.layer);
            if(savedState.hill) toggleHillshade(true);
            map.on('moveend', saveMapState);
            updateMapDisplay();
        }

        function handleGpxUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                new L.GPX(e.target.result, { async: true }).on('loaded', (e) => {

                    const trackData = e.target.getLayers()[0].getLatLngs();
                    storage.push({
                        id: Date.now(),
                        type: 'track',
                        name: file.name.replace('.gpx', ''),
                        path: trackData.map(ll => [ll.lat, ll.lng]),
                        selected: false,
                        date: new Date().toLocaleDateString()
                    });
                    saveAndSync();
                    map.fitBounds(e.target.getBounds());
                });
            };
            reader.readAsText(file);
        }

        function toggleLayerPanel() {
            const panel = document.getElementById('layer-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function changeLayer(type) {
            if(currentBaseLayer) map.removeLayer(currentBaseLayer);
            currentBaseLayer = baseMaps[type];
            currentBaseLayer.addTo(map);
            document.getElementById('rad-' + type).checked = true;
            localStorage.setItem('active_layer', type);
            saveMapState();
        }

        function toggleHillshade(force = null) {
            const chk = document.getElementById('chk-hill');
            const shouldAdd = force !== null ? force : !map.hasLayer(hillshadeLayer);
            if(!hillshadeLayer) hillshadeLayer = L.tileLayer('https://{s}.tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', { opacity: 0.5 });

            if(shouldAdd) { hillshadeLayer.addTo(map); chk.checked = true; } 
            else { map.removeLayer(hillshadeLayer); chk.checked = false; }
            saveMapState();
        }

        function saveMapState() {
            localStorage.setItem('map_state', JSON.stringify({
                center: map.getCenter(),
                zoom: map.getZoom(),
                layer: localStorage.getItem('active_layer') || 'std',
                hill: document.getElementById('chk-hill').checked
            }));
        }

        function setupGestures() {
            const mapEl = document.getElementById('map');

            mapEl.addEventListener('click', () => {
                document.body.classList.add('fullscreen');
                document.getElementById('main-header').classList.add('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
                setTimeout(() => map.invalidateSize(), 300);
            });
            mapEl.addEventListener('touchstart', (e) => {
                const now = Date.now();
                if (now - lastTap < 300) {
                    document.body.classList.remove('fullscreen');
                    document.getElementById('main-header').classList.remove('hidden');
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    setTimeout(() => map.invalidateSize(), 300);

                }
                lastTap = now;
            });
        }

        function toggleMapMenu() {
            const tools = document.getElementById('extra-tools');
            const icon = document.getElementById('toggleIcon');
            tools.classList.toggle('show');
            icon.className = tools.classList.contains('show') ? "fas fa-times" : "fas fa-plus";
        }

        function saveCurrentLocation() {
            map.locate({setView: false});
            map.once('locationfound', (e) => {
                const name = prompt("Name this location:");
                if(name) {
                    storage.push({ id: Date.now(), type: 'point', name, lat: e.latlng.lat, lng: e.latlng.lng, selected: false });
                    saveAndSync();
                }
            });
        }

        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('rec-btn');
            if(isRecording) {
                userTrack = [];
                btn.style.color = "#ff4444";
                map.locate({ watch: true });
                map.on('locationfound', (e) => userTrack.push([e.latlng.lat, e.latlng.lng]));
            } else {
                btn.style.color = "white";
                map.stopLocate();
                if(userTrack.length > 1) {
                    const name = prompt("Name this track:");
                    storage.push({ id: Date.now(), type: 'track', name: name || "New Track", path: userTrack, selected: false });
                    saveAndSync();
                }
            }
        }

        function findMe() { map.locate({setView: true, maxZoom: 16}); }

        function renderStorage() {
            const list = document.getElementById('storage-list');
            list.innerHTML = "";
            let anySelected = false;
            storage.forEach(item => {
                if(item.selected) anySelected = true;
                const card = document.createElement('div');
                card.className = `storage-card ${item.selected ? 'selected' : ''}`;
                let timer;
                card.onmousedown = card.ontouchstart = () => timer = setTimeout(() => toggleSelect(item.id), 600);
                card.onmouseup = card.ontouchend = () => clearTimeout(timer);
                card.innerHTML = `<div class="card-main" onclick="focusOnMap(${item.id})"><span>${item.type === 'point' ? '📍' : '🛤️'} ${item.name}</span><i class="fas fa-chevron-right"></i></div>`;
                list.appendChild(card);
            });
            document.getElementById('delete-btn').style.display = anySelected ? 'block' : 'none';
        }

        function toggleSelect(id) {
            const item = storage.find(i => i.id === id);
            item.selected = !item.selected;
            renderStorage();
        }

        function deleteSelected() {
            if(confirm("Delete selected items?")) {

                storage = storage.filter(i => !i.selected);
                saveAndSync();
            }
        }

        function focusOnMap(id) {
            const item = storage.find(i => i.id === id);
            switchView('tab-map');
            if(item.type === 'point') map.setView([item.lat, item.lng], 16);
            else map.fitBounds(L.polyline(item.path).getBounds());
        }

        function updateMapDisplay() {
            Object.values(mapLayers).forEach(l => map.removeLayer(l));
            storage.forEach(item => {
                if(item.type === 'point') mapLayers[item.id] = L.marker([item.lat,item.lng]).addTo(map).bindPopup(item.name);
                else mapLayers[item.id] = L.polyline(item.path, {color: 'var(--primary)'}).addTo(map).bindPopup(item.name);
            });
        }

        function saveAndSync() {
            localStorage.setItem('app_storage', JSON.stringify(storage));
            renderStorage();
            updateMapDisplay();
        }

        function switchView(id) {
            document.querySelectorAll('.page, .nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const navItems = document.querySelectorAll('.nav-item');
            if(id === 'tab-time') navItems[0].classList.add('active');
            if(id === 'tab-map') { navItems[1].classList.add('active'); setTimeout(() => map.invalidateSize(), 200); }
            if(id === 'tab-storage') navItems[2].classList.add('active');
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-display').textContent = 
                    now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            }, 1000);
        }
    </script>
</body>
</html>